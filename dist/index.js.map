{"version":3,"sources":["../src/index.tsx"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import * as React from 'react';\nimport axios from 'axios';\nimport state_definition from './state';\n\n\n\nexport interface WithConfigState {\n    error: boolean;\n    loading: boolean;\n}\n\ntype Status = \"not_initialized\" | \"fetching\" | \"completed\" | \"failed\";\n\nlet stores = [];\n\nlet base_uri = window.location.protocol + '//' + window.location.host;\nlet config_asset_uri = '/config.json';\n\nlet default_cfg: object = {};\nlet fetched_cfg: object = {};\nlet combined_cfg = {};\n\nlet debug_cb = null;\n\nlet fetched_cb = null;\nlet fetching_error_cb = null;\nlet fetching_error = null;\n\nlet fetching_status: Status = 'not_initialized';\nlet get_config_listeners = [];\nlet component_listeners = [];\n\nfunction initiateFetch(): Promise<any> {\n    fetching_status = 'fetching';\n    if (debug_cb) {\n        debug_cb(\"Fetching: \" + base_uri + config_asset_uri);\n    }\n\n    return axios({\n        url: base_uri + config_asset_uri,\n        method: 'GET'\n    }).then((res) => {\n        fetched_cfg = res.data;\n        if (debug_cb) {\n            debug_cb(\"Fetch completed \" + JSON.stringify(fetched_cfg));\n        }\n        combined_cfg = Object.assign({}, default_cfg, fetched_cfg);\n        fetching_status = 'completed';\n        stores.forEach((store) => {\n            store.actions.set(combined_cfg);\n        });\n        if (fetched_cb !== null) {\n            fetched_cb(combined_cfg);\n        }\n        get_config_listeners.forEach((listener) => {\n            listener();\n        });\n        setTimeout(() => {\n            //Timeout here to force the component listeners to the end of the execution chain,\n            //after the callbacks have all been executed.\n            component_listeners.forEach((listener) => {\n                listener();\n            });\n            if (debug_cb) {\n                debug_cb(\"Component listeners called.\");\n            }\n        }, 10);\n    }).catch((err) => {\n        if (debug_cb) {\n            debug_cb(\"Fetching failed: \" + err.message);\n        }\n        fetching_status = 'failed';\n        err.network_error = true;\n        fetching_error = err;\n        if (fetching_error_cb !== null) {\n            fetching_error_cb(err);\n            return;\n        }\n        if (\n            get_config_listeners.length === 0 &&\n            fetching_error_cb === null\n        ) {\n            console.error('withConfig: ERROR WHEN FETCHING CONFIG:');\n            console.error(err);\n        }\n        get_config_listeners.forEach((listener) => {\n            listener();\n        });\n        component_listeners.forEach((listener) => {\n            listener();\n        });\n        throw err;\n    });\n}\n\nfunction getCfg(): Promise<any> {\n    return new Promise((resolve, reject) => {\n        if (fetching_status === 'completed') {\n            resolve(combined_cfg);\n            return;\n        }\n        if (fetching_status === 'failed') {\n            reject(fetching_error);\n            return;\n        }\n        get_config_listeners.push(() => {\n            if (fetching_status === 'completed') {\n                resolve(combined_cfg);\n                return;\n            }\n            reject(fetching_error);\n            return;\n        });\n        if (fetching_status === 'not_initialized') {\n            initiateFetch();\n        }\n    });\n}\n\nfunction getCurrentCfg(): any {\n    if (fetching_status !== \"completed\") {\n        console.warn(`withConfig: getConfig was run before config finished fetching.\n        withConfig.fetch() returns a promise which resolves when fetch completes, you might want to use it instead.`);\n    }\n    return combined_cfg;\n}\n\n\nexport function WithConfigHOC(\n    WrappedComponent: typeof React.Component,\n    SpinnerComponent?: typeof React.Component,\n    ErrorComponent?: typeof React.Component\n): typeof React.Component {\n    class WithConfig extends React.Component<any, WithConfigState> {\n        constructor(props) {\n            super(props);\n\n            this.state = { error: false, loading: true };\n        }\n\n        componentListener() {\n            if (fetching_status === 'failed') {\n                this.setState({ error: true });\n            }\n            this.setState({ loading: false });\n        }\n\n        componentDidMount() {\n            component_listeners.push(() => {\n                this.componentListener();\n            });\n            if (fetching_status === 'completed') {\n                this.setState({ loading: false });\n                return;\n            }\n            if (fetching_status === 'not_initialized') {\n                initiateFetch();\n            }\n        }\n\n        componentWillUnmount() {\n            let listener_index = component_listeners.indexOf(\n                this.componentListener\n            );\n            component_listeners.splice(listener_index, 1);\n        }\n\n        render() {\n            if (this.state.error) {\n                if (ErrorComponent) {\n                    return <ErrorComponent />;\n                }\n                return (\n                    <p\n                        style={{\n                            textAlign: 'center',\n                            marginTop: '20%'\n                        }}\n                    >\n                        Oops, something went wrong.\n                    </p>\n                );\n            }\n            let store_status = stores.every((store) => {\n                return store.getState().config_initialized === true;\n            });\n\n            if (this.state.loading || !store_status) {\n                if (SpinnerComponent) {\n                    return <SpinnerComponent {...this.props} />;\n                }\n                return null;\n            }\n            return <WrappedComponent config={combined_cfg} config_state={this.state} {...this.props} />;\n        }\n    }\n\n    return WithConfig;\n}\n\nexport namespace WithConfigHOC {\n    export function setDefault(default_config) {\n        if (Object.keys(default_cfg).length > 0) {\n            console.error('withConfig error: Cannot setDefault; Default config already set!');\n            return;\n        }\n        if (typeof default_config !== 'object') {\n            console.error('withConfig error: Arguemnt default_config is required to be an object.');\n            return;\n        }\n        default_cfg = default_config;\n        combined_cfg = Object.assign({}, default_cfg, fetched_cfg);\n    }\n    export function get() {\n        return getCfg();\n    }\n    export function getCurrentConfig() {\n        return getCurrentCfg();\n    }\n    export function getDefault() {\n        return default_cfg;\n    }\n    export function getFetched() {\n        return fetched_cfg;\n    }\n    export function setFetchedCallback(cb) {\n        fetched_cb = cb;\n    }\n    export function setFetchingErrorCallback(cb) {\n        fetching_error_cb = cb;\n    }\n    export function addStore(store) {\n        let i = stores.push(store.addState(\"config\", state_definition));\n        if (stores[i - 1].hasOwnProperty(\"addUpdateCallback\") === false) {\n            throw new Error(\"Missing prop 'addUpdateCallback' on addState return object. Ensure store version >=3.0.8.\");\n        }\n        stores[i - 1].addUpdateCallback(() => {\n            component_listeners.forEach((listener) => {\n                listener();\n            });\n        });\n        if (fetching_status === \"completed\") {\n            stores[i - 1].actions.set(combined_cfg);\n        }\n    }\n    export function setDebugCallback(cb) {\n        debug_cb = cb;\n    }\n}\n\nexport default WithConfigHOC;\n"],"sourceRoot":"/source/"}