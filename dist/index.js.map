{"version":3,"sources":["../src/index.tsx"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import * as React from 'react';\nimport axios from 'axios';\nimport withState from 'with-state';\nimport state_definition from './state';\n\n\nexport interface WithConfigFunction {\n    setDefault: (any) => void;\n    fetch: () => any;\n    getConfig: () => Promise<any>;\n    getDefault: () => any;\n    getFetched: () => any;\n    setFetchedCallback: (cb: (any) => any) => void;\n    setFetchingErrorCallback: (cb: (any) => any) => void;\n}\n\nexport interface WithConfigState {\n    error: boolean;\n    loading: boolean;\n}\n\nlet state = withState.addState(\"config\", state_definition);\n\nlet base_uri = window.location.protocol + '//' + window.location.host;\nlet config_asset_uri = '/config.json';\n\nlet default_cfg = null;\nlet fetched_cfg = null;\nlet combined_cfg = {};\n\nlet fetched_cb = null;\nlet fetching_error_cb = null;\nlet fetching_error = null;\n\nlet fetching_status = 'not_initialized';\nlet get_config_listeners = [];\nlet component_listeners = [];\n\nfunction initiateFetch(): Promise<any> {\n    fetching_status = 'fetching';\n\n    return axios({\n        url: base_uri + config_asset_uri,\n        method: 'GET'\n    })\n        .then((res) => {\n            fetched_cfg = res.data;\n            combined_cfg = Object.assign({}, default_cfg, fetched_cfg);\n            fetching_status = 'completed';\n            state.actions.set(combined_cfg);\n            if (fetched_cb !== null) {\n                fetched_cb(combined_cfg);\n            }\n            get_config_listeners.forEach((listener) => {\n                listener();\n            });\n            component_listeners.forEach((listener) => {\n                listener();\n            });\n        })\n        .catch((err) => {\n            fetching_status = 'failed';\n            err.network_error = true;\n            fetching_error = err;\n            if (fetching_error_cb !== null) {\n                fetching_error_cb(err);\n                return;\n            }\n            if (\n                get_config_listeners.length === 0 &&\n                fetching_error_cb === null\n            ) {\n                console.error('withConfig: ERROR WHEN FETCHING CONFIG:');\n                console.error(err);\n            }\n            get_config_listeners.forEach((listener) => {\n                listener();\n            });\n            component_listeners.forEach((listener) => {\n                listener();\n            });\n            throw err;\n        });\n}\n\nfunction getCfg(): Promise<any> {\n    return new Promise((resolve, reject) => {\n        if (fetching_status === 'completed') {\n            resolve(combined_cfg);\n            return;\n        }\n        if (fetching_status === 'failed') {\n            reject(fetching_error);\n            return;\n        }\n        get_config_listeners.push(() => {\n            if (fetching_status === 'completed') {\n                resolve(combined_cfg);\n                return;\n            }\n            reject(fetching_error);\n            return;\n        });\n        if (fetching_status === 'not_initialized') {\n            initiateFetch();\n        }\n    });\n}\n\n\n\n\n\nexport function WithConfigHOC (\n    WrappedComponent: typeof React.Component,\n    SpinnerComponent?: typeof React.Component,\n    ErrorComponent?: typeof React.Component\n): typeof React.Component {\n    class WithConfig extends React.Component<any, WithConfigState> {\n        constructor(props) {\n            super(props);\n\n            this.state = { error: false, loading: true };\n        }\n\n        componentListener() {\n            if (fetching_status === 'failed') {\n                this.setState({ error: true });\n            }\n            this.setState({ loading: false });\n        }\n\n        componentDidMount() {\n            component_listeners.push(() => {\n                this.componentListener();\n            });\n            if (fetching_status === 'completed') {\n                this.setState({ loading: false });\n                return;\n            }\n            if (fetching_status === 'not_initialized') {\n                initiateFetch();\n            }\n        }\n\n        componentWillUnmount() {\n            let listener_index = component_listeners.indexOf(\n                this.componentListener\n            );\n            component_listeners.splice(listener_index, 1);\n        }\n\n        render() {\n            if (this.state.error) {\n                if (ErrorComponent) {\n                    return <ErrorComponent />;\n                }\n                return (\n                    <p\n                        style={{\n                            textAlign: 'center',\n                            marginTop: '20%'\n                        }}\n                    >\n                        Oops, something went wrong.\n                    </p>\n                );\n            }\n            if (this.state.loading) {\n                if (SpinnerComponent) {\n                    return <SpinnerComponent {...this.props} />;\n                }\n                return null;\n            }\n            return <WrappedComponent config={combined_cfg} {...this.props} />;\n        }\n    }\n\n    return WithConfig;\n}\n\nexport namespace WithConfigHOC {\n    export function setDefault(default_config) {\n        if (default_cfg !== null) {\n            console.error(\n                'withConfig error: Cannot setDefault; Default config already set!'\n            );\n            return;\n        }\n        if (typeof default_config !== 'object') {\n            console.error(\n                'withConfig error: Arguemnt default_config is required to be an object.'\n            );\n            return;\n        }\n        if (fetching_status !== 'not_initialized') {\n            console.error(\n                'withConfig error: Cannot setDefault after a withConfig-wrapped component has been mounted.'\n            );\n            return;\n        }\n        default_cfg = default_config;\n        combined_cfg = Object.assign({}, default_cfg);\n    }\n    export function fetch() {\n        return getCfg();\n    }\n    export function getConfig() {\n        return getCfg();\n    }\n    export function getDefault() {\n        return default_cfg;\n    }\n    export function getFetched() {\n        return fetched_cfg;\n    }\n    export function setFetchedCallback(cb) {\n        fetched_cb = cb;\n    }\n    export function setFetchingErrorCallback(cb) {\n        fetching_error_cb = cb;\n    }\n}\n\nexport default WithConfigHOC;\n"],"sourceRoot":"/source/"}